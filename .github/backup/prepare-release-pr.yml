name: Prepare release PR

on:
    push: 
        tags:
            - '**'
        branches: 
            - main
    workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}

env:
    PRERELEASE_SUFFIX: rc
    BRANCH: main
    CLIFF_CONFIG_PATH: cliff.toml
    CHANGELOG_PATH: CHANGELOG.md
    HELM_CHART_PATH: charts/learnrelease/Chart.yaml
    PRE_RELEASE_PR_BRANCH: release/prerelease
    STABLE_RELEASE_PR_BRANCH: release/stable


jobs:
    metadata:
      name: Metadata
      runs-on: ubuntu-latest
      permissions:
        contents: read
      outputs:
        next_stable_tag: ${{ steps.ver.outputs.next_stable_tag }}
        next_prerelease_tag: ${{ steps.ver.outputs.next_prerelease_tag }}
        next_stable_tag_greater_than_latest: ${{ steps.ver.outputs.next_stable_tag_greater_than_latest }}
        next_prerelease_tag_greater_than_latest: ${{ steps.ver.outputs.next_prerelease_tag_greater_than_latest }}
        latest_tag: ${{ steps.ver.outputs.latest_tag }}
        commits_since_latest_tag: ${{ steps.ver.outputs.commits_since_latest_tag }}
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - uses: actions/setup-go@v5
          with:
              go-version-file: go.mod
        - name: Install git-semver
          run: |
            go install github.com/psanetra/git-semver/cli@v1.1.2
            mv $(which cli) $(dirname $(which cli))/git-semver
        - name: Build release and prerelease tag
          id: ver
          run: |
            next_prerelease_tag=v$(git-semver next --pre-release-tag $PRERELEASE_SUFFIX --pre-release-counter)
            next_stable_tag=v$(git-semver next)
            latest_tag=v$(git-semver latest --include-pre-releases)

            if git show-ref --quiet --verify "refs/tags/${latest_tag}"; then
                echo "Counting commits since ${latest_tag}"
                commits_since_latest_tag=$(git log  --oneline ${latest_tag}..HEAD | wc -l)
            else
                echo "Counting all commits"
                commits_since_latest_tag=$(git log --oneline | wc -l)
            fi

            next_stable_tag_greater_than_latest="false"
            if [ "$(git-semver compare $next_stable_tag $latest_tag 2>&1)" = ">" ]; then
                next_stable_tag_greater_than_latest="true"
            fi

            next_prerelease_tag_greater_than_latest="false"
            if [ "$(git-semver compare $next_prerelease_tag $latest_tag 2>&1)" = ">" ]; then
                next_prerelease_tag_greater_than_latest="true"
            fi

            echo "next_prerelease_tag=$next_prerelease_tag" >>"$GITHUB_OUTPUT"
            echo "next_stable_tag=$next_stable_tag" >>"$GITHUB_OUTPUT"
            echo "next_stable_tag_greater_than_latest=$next_stable_tag_greater_than_latest" >>"$GITHUB_OUTPUT"
            echo "next_prerelease_tag_greater_than_latest=$next_prerelease_tag_greater_than_latest" >>"$GITHUB_OUTPUT"
            echo "commits_since_latest_tag=$commits_since_latest_tag" >>"$GITHUB_OUTPUT"
        - name: Show computed version
          run: |
            echo "next_prerelease_tag = ${{ steps.ver.outputs.next_prerelease_tag }}"
            echo "next_stable_tag = ${{ steps.ver.outputs.next_stable_tag }}"
            echo "next_stable_tag_greater_than_latest = ${{ steps.ver.outputs.next_stable_tag_greater_than_latest }}"
            echo "next_prerelease_tag_greater_than_latest = ${{ steps.ver.outputs.next_prerelease_tag_greater_than_latest }}"
            echo "commits_since_latest_tag = ${{ steps.ver.outputs.commits_since_latest_tag }}"        

    stable-release-pr:
      name: Stable release PR
      runs-on: ubuntu-latest
      needs: metadata
      permissions: 
        pull-requests: write
        contents: write
        issues: write
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
            ref: ${{ env.BRANCH }}
        - name: Generate stable release changelog
          if: needs.metadata.outputs.next_stable_tag_greater_than_latest == 'true'
          uses: orhun/git-cliff-action@v4
          with:
            config: ${{ env.CLIFF_CONFIG_PATH }}
            args:
              -vv --tag ${{ needs.metadata.outputs.next_stable_tag }} --ignore-tags ${{ env.PRERELEASE_SUFFIX }}
          env:
            OUTPUT: ${{ env.CHANGELOG_PATH }}

        - name: Generate stable release changelog for PR body
          if: needs.metadata.outputs.next_stable_tag_greater_than_latest == 'true'  
          id: stable-changelog
          uses: orhun/git-cliff-action@v4
          with:
            config: ${{ env.CLIFF_CONFIG_PATH }}
            args:
              -vv -u --strip all --tag ${{ needs.metadata.outputs.next_stable_tag }} --ignore-tags ${{ env.PRERELEASE_SUFFIX }}
          env:
            OUTPUT: ${{ runner.temp }}/stablechangelog.md

        - name: Update stable version in Chart.yaml
          if: needs.metadata.outputs.next_stable_tag_greater_than_latest == 'true'
          env:
            tag: ${{ needs.metadata.outputs.next_stable_tag }}
          run: >
            yq
            '.version = (strenv(tag) | sub("^v";"")), .appVersion = (strenv(tag) | sub("^v";""))'
            -i ${{ env.HELM_CHART_PATH }}
            
        - name: Create stable release PR
          uses: peter-evans/create-pull-request@v7
          with:
            base: ${{ env.BRANCH }}
            delete-branch: true
            title: "chore: release ${{ needs.metadata.outputs.next_stable_tag }}"
            branch: ${{ env.STABLE_RELEASE_PR_BRANCH }}
            labels: "release: pending"
            body: ${{ steps.stable-changelog.outputs.content }}
            commit-message: "chore(release): prepare for stable release ${{ needs.metadata.outputs.next_stable_tag }}"
            sign-commits: true
            add-paths: |
              ${{ env.CHANGELOG_PATH }}
              ${{ env.HELM_CHART_PATH }}

    prerelease-pr:
      name: Prerelease PR
      runs-on: ubuntu-latest
      needs: metadata
      permissions: 
        pull-requests: write
        contents: write
        issues: write
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
            ref: ${{ env.BRANCH }}
        - name: Generate prerelease changelog for PR body
          if: needs.metadata.outputs.next_prerelease_tag_greater_than_latest == 'true' && needs.metadata.outputs.commits_since_latest_tag > 0
          id: unreleased-changelog
          uses: orhun/git-cliff-action@v4
          with:
            config: ${{ env.CLIFF_CONFIG_PATH }}
            args:
              -vv -u --strip all --tag ${{ needs.metadata.outputs.next_prerelease_tag }}
          env:
            OUTPUT: ${{ runner.temp }}/prereleasechangelog.md                
        - name: Update prerelease version in Chart.yaml
          # if: needs.metadata.outputs.commits_since_latest_tag > 0
          if: needs.metadata.outputs.next_prerelease_tag_greater_than_latest == 'true' && needs.metadata.outputs.commits_since_latest_tag > 0
          env:
            tag: ${{ needs.metadata.outputs.next_prerelease_tag }}
          run: >
            yq
            '.version = (strenv(tag) | sub("^v";"")), .appVersion = (strenv(tag) | sub("^v";""))'
            -i ${{ env.HELM_CHART_PATH }}
        - name: Create prerelease PR
          uses: peter-evans/create-pull-request@v7
          with:
            base: ${{ env.BRANCH }}
            delete-branch: true
            title: "chore: prerelease ${{ needs.metadata.outputs.next_prerelease_tag }}"
            branch: ${{ env.PRE_RELEASE_PR_BRANCH }}
            labels: "release: pending"
            body: ${{ steps.unreleased-changelog.outputs.content }}
            commit-message: "chore(release): prepare for prerelease ${{ needs.metadata.outputs.next_prerelease_tag }}"
            sign-commits: true
            add-paths: |
              ${{ env.HELM_CHART_PATH }}
